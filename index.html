<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Textbausteine CSV für mehrere Namen und Server</title>
<style>
body { font-family: sans-serif; margin: 2em; }
label { display:block; margin-top: 1em; }
input, textarea { width: 100%; margin-top: 0.3em; padding: 0.3em; }
#titleBox, #preview { border: 1px solid #aaa; padding: 1em; margin-top: 1em; white-space: pre-wrap; }
button { margin-top: 0.5em; }
</style>
</head>
<body>

<h1>Textbausteine ausfüllen (mehrere Namen & Server, CSV nur Felder)</h1>

<label for="templateSelect">Vorlage auswählen:</label>
<select id="templateSelect"></select>

<form id="inputForm"></form>
<button type="button" onclick="updatePreview()">Vorschau aktualisieren</button>

<h2>Titel-Vorschau</h2>
<div id="titleBox"></div>

<h2>Text-Vorschau</h2>
<div id="preview"></div>

<button onclick="downloadCSV()">CSV herunterladen</button>

<script>
const templates = [
  { 
    name: "Rechnung", 
    title: "Rechnung für {{name}}", 
    text: "Sehr geehrte/r {{name}},\nHiermit erhalten Sie die Rechnung für {{server}} über {{betrag}} Euro.\n\nMit freundlichen Grüßen\n{{firma}}", 
    fields: { name: "", server: "", firma: "", betrag: "", datum: new Date().toLocaleDateString(), rechnungsnr: "R-1001" }
  }
];

const select = document.getElementById('templateSelect');
const form = document.getElementById('inputForm');
const preview = document.getElementById('preview');
const titleBox = document.getElementById('titleBox');

templates.forEach((t,i)=>{
  let opt = document.createElement('option');
  opt.value = i; opt.textContent = t.name;
  select.appendChild(opt);
});

function escapeRegex(str) {
  return str.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&');
}

function buildFormForTemplate(t){
  form.innerHTML = '';
  for(const key in t.fields){
    const label = document.createElement('label');
    label.textContent = key + ((key==='server' || key==='name') ? ' (mehrere durch Komma trennen)' : '') + ':';
    const input = document.createElement('input');
    input.name = key;
    input.value = t.fields[key] || '';
    form.appendChild(label);
    form.appendChild(input);
  }
}

select.addEventListener('change',()=>{
  buildFormForTemplate(templates[select.value]);
  updatePreview();
});

buildFormForTemplate(templates[0]);

function updatePreview(){
  const t = templates[select.value];
  const data = {};
  [...form.elements].forEach(el=>{ if(el.name) data[el.name]=el.value; });

  // Titel einmalig füllen (Name nur Platzhalter, wird in CSV ersetzt)
  let outTitle = t.title;
  const titleData = {...data}; delete titleData.server;
  for(const [key,val] of Object.entries(titleData)){
    const re = new RegExp('{{\\s*' + escapeRegex(key) + '\\s*}}','g');
    outTitle = outTitle.replace(re,val);
  }
  titleBox.innerText = outTitle;

  let outText = t.text;
  const textData = {...data}; delete textData.server;
  for(const [key,val] of Object.entries(textData)){
    const re = new RegExp('{{\\s*' + escapeRegex(key) + '\\s*}}','g');
    outText = outText.replace(re,val);
  }
  preview.innerText = outText;
}

function downloadCSV(){
  const t = templates[select.value];
  const data = {};
  [...form.elements].forEach(el=>{ if(el.name) data[el.name]=el.value; });

  const names = (data.name || '').split(',').map(s=>s.trim()).filter(s=>s);
  const servers = (data.server || '').split(',').map(s=>s.trim()).filter(s=>s);

  const rows = [];
  names.forEach(name => {
    if(servers.length > 0){
      servers.forEach(server => {
        rows.push({...data, name, server});
      });
    } else {
      rows.push({...data, name});
    }
  });

  const csvFields = Object.keys(t.fields);
  const csvLines = [csvFields.join(';')];

  rows.forEach(r => {
    const values = csvFields.map(k=>r[k] || '');
    csvLines.push(values.join(';'));
  });

  const blob = new Blob([csvLines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'daten.csv';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
</body>
</html>
