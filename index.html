<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Dynamische Textbausteine mit CSV-Header Mapping</title>
<style>
body { font-family: sans-serif; margin: 2em; }
label { display:block; margin-top: 1em; }
input, textarea { width: 100%; margin-top: 0.3em; padding: 0.3em; }
#titleBox, #preview { border: 1px solid #aaa; padding: 1em; margin-top: 1em; white-space: pre-wrap; }
button { margin-top: 0.5em; }
</style>
</head>
<body>

<h1>Dynamische Textbausteine (CSV-Header Mapping)</h1>

<label for="templateSelect">Vorlage auswählen:</label>
<select id="templateSelect"></select>

<form id="inputForm"></form>
<button type="button" onclick="updatePreview()">Vorschau aktualisieren</button>

<h2>Titel-Vorschau</h2>
<div id="titleBox"></div>

<h2>Text-Vorschau</h2>
<div id="preview"></div>

<button onclick="downloadCSV()">CSV herunterladen</button>

<script>
const templates = [
  { 
    name: "Rechnung", 
    title: "Rechnung für {{name}} - Ticket {{ticket nr}}", 
    text: "Sehr geehrte/r {{name}},\nHiermit erhalten Sie die Rechnung für {{server}} über {{betrag}} Euro. Ticket-Nr: {{ticket nr}}\n\nMit freundlichen Grüßen\n{{firma tews}}", 
    fields: { name: "", server: "", firma_tews: "", betrag: "" } // CSV-Felder
  }
];

const select = document.getElementById('templateSelect');
const form = document.getElementById('inputForm');
const preview = document.getElementById('preview');
const titleBox = document.getElementById('titleBox');

templates.forEach((t,i)=>{
  let opt = document.createElement('option');
  opt.value = i; opt.textContent = t.name;
  select.appendChild(opt);
});

function escapeRegex(str) {
  return str.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&');
}

function sanitizeKey(key){
  return key.replace(/ /g,'_'); // HTML-Name
}

function unsanitizeKey(key){
  return key.replace(/_/g,' '); // Für CSV Header und Vorschau
}

function buildFormForTemplate(t){
  form.innerHTML = '';
  // CSV-Felder
  for(const key in t.fields){
    const label = document.createElement('label');
    label.textContent = unsanitizeKey(key) + ((key==='server' || key==='name') ? ' (mehrere durch Komma trennen)' : '') + ':';
    const input = document.createElement('input');
    input.name = key;
    input.value = t.fields[key] || '';
    form.appendChild(label);
    form.appendChild(input);
  }
  // Variablen aus Titel/Text (nicht in fields)
  const allPlaceholders = new Set((t.title+t.text).match(/{{\s*([a-zA-Z0-9_äöüÄÖÜß ]+)\s*}}/g)||[]);
  allPlaceholders.forEach(ph => {
    const key = ph.replace(/[{}]/g,'').trim();
    const inputName = sanitizeKey(key);
    if(!(key in t.fields) && !form.querySelector(`[name='${inputName}']`)){
      const label = document.createElement('label');
      label.textContent = key + ':';
      const input = document.createElement('input');
      input.name = inputName;
      input.value = '';
      form.appendChild(label);
      form.appendChild(input);
    }
  });
}

select.addEventListener('change',()=>{
  buildFormForTemplate(templates[select.value]);
  updatePreview();
});

buildFormForTemplate(templates[0]);

function parseMultipleValues(value){
  return value.split(',').map(s=>s.trim()).filter(s=>s);
}

function getAllCombinations(data, multiKeys){
  if(multiKeys.length === 0) return [data];
  const [key, ...rest] = multiKeys;
  const values = parseMultipleValues(data[key] || '');
  const combinations = [];
  values.forEach(v => {
    const copy = {...data, [key]: v};
    combinations.push(...getAllCombinations(copy, rest));
  });
  return combinations;
}

function fillPlaceholders(templateStr, data){
  return templateStr.replace(/{{\s*([a-zA-Z0-9_äöüÄÖÜß ]+)\s*}}/g,(m,k)=>{
    const key = sanitizeKey(k); // HTML-Name
    return data[key] !== undefined ? data[key] : m;
  });
}

function updatePreview(){
  const t = templates[select.value];
  const data = {};
  [...form.elements].forEach(el=>{ if(el.name) data[el.name]=el.value; });

  const multiKeys = Object.keys(t.fields).filter(k=>['name','server'].includes(k));
  const combos = getAllCombinations(data, multiKeys);

  titleBox.innerText = combos.map(c=>fillPlaceholders(t.title,c)).join('\n-------------------\n');
  preview.innerText = combos.map(c=>fillPlaceholders(t.text,c)).join('\n-------------------\n');
}

function downloadCSV(){
  const t = templates[select.value];
  const data = {};
  [...form.elements].forEach(el=>{ if(el.name) data[el.name]=el.value; });

  const multiKeys = Object.keys(t.fields).filter(k=>['name','server'].includes(k));
  const combos = getAllCombinations(data, multiKeys);

  const csvFields = Object.keys(t.fields);
  const csvHeader = csvFields.map(f => unsanitizeKey(f)); // _ → Leerzeichen
  const csvLines = [csvHeader.join(';')];

  combos.forEach(r => {
    const values = csvFields.map(k=>r[k]||'');
    csvLines.push(values.join(';'));
  });

  const blob = new Blob([csvLines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'daten.csv';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
</body>
</html>
